<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat con TOT · FedEx</title>
  <style>
    :root { --bg:#0b1220; --panel:#101828; --ink:#e5eefc; --muted:#98a2b3; --ok:#22c55e; --warn:#f59e0b; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--ink); font:16px/1.4 ui-sans-serif, system-ui, Segoe UI, Roboto; }
    header { display:flex; align-items:center; gap:.75rem; padding:12px 16px; background:var(--panel); position:sticky; top:0; z-index:10; }
    .title { font-weight:700; }
    .chip { margin-left:auto; padding:.25rem .5rem; border-radius:999px; background:#1f2937; color:#cbd5e1; font-size:.8rem; }
    main { display:flex; flex-direction:column; height:calc(100vh - 56px); }
    #stream { flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:10px; }
    .row { display:flex; }
    .row.user { justify-content:flex-end; }
    .bubble { max-width:72ch; padding:10px 12px; border-radius:14px; white-space:pre-wrap; }
    .row.user .bubble { background:#0ea5e9; color:#fff; border-bottom-right-radius:4px; }
    .row.bot  .bubble { background:#111827; border:1px solid #25324b; border-bottom-left-radius:4px; }
    .composer { display:flex; gap:8px; padding:12px; border-top:1px solid #1f2937; background:var(--panel); }
    textarea { flex:1; resize:none; min-height:44px; max-height:40vh; padding:10px; border-radius:10px; border:1px solid #263041; background:#0b1325; color:var(--ink); }
    button { border:0; border-radius:10px; padding:10px 14px; background:var(--ok); color:#04210b; font-weight:700; cursor:pointer; }
    .muted { color:var(--muted); }
    dialog { border:1px solid #243046; background:#0b1325; color:var(--ink); border-radius:12px; padding:16px; max-width:520px; }
    .field { display:grid; gap:6px; margin:10px 0; }
    .field > label { font-size:.85rem; color:var(--muted); }
    .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .gear { background:var(--warn); }
  </style>
</head>
<body>
  <header>
    <div class="title">Chat con TOT · FedEx</div>
    <div id="sessionChip" class="chip" title="">Sesión: —</div>
    <button id="cfgBtn" class="gear" title="Configurar">⚙︎</button>
  </header>

  <main>
    <div id="stream" class="stream" aria-live="polite" aria-busy="false"></div>
    <div class="composer">
      <textarea id="input" placeholder="Escribe tu mensaje… (Enter para enviar, Shift+Enter para salto de línea)"></textarea>
      <button id="sendBtn">Enviar ▶</button>
    </div>
  </main>

  <dialog id="cfgDlg">
    <h3 style="margin:0 0 8px 0;">Configurar webhook</h3>
    <div class="field">
      <label>URL base (opcional)</label>
      <input id="baseUrl" placeholder="https://metatron.aircraftcare.net" style="padding:8px;border-radius:8px;border:1px solid #243046;background:#0b1325;color:#e5eefc" />
    </div>
    <div class="field">
      <label>Path o ID</label>
      <input id="path" placeholder="webhook/xxxx-xxxx" style="padding:8px;border-radius:8px;border:1px solid #243046;background:#0b1325;color:#e5eefc" />
    </div>
    <div class="field">
      <label>Headers opcionales (JSON)</label>
      <input id="headers" placeholder='{"Authorization":"Bearer ..."}' style="padding:8px;border-radius:8px;border:1px solid #243046;background:#0b1325;color:#e5eefc" />
    </div>
    <div class="actions">
      <button id="newSessBtn" style="background:#64748b">Nueva sesión</button>
      <button id="saveCfgBtn">Guardar</button>
      <button id="closeCfgBtn" style="background:#ef4444">Cerrar</button>
    </div>
  </dialog>

  <script>
  (function () {
    "use strict";

    // ===== Config por agente =====
    const DEFAULT_WEBHOOK = "https://metatron.aircraftcare.net/webhook/bf4dd093-bb02-472c-9454-7ab9af97bd1d";
    const AGENT_PREFIX = "tot:";

    // ===== Utilidades UI =====
    const $ = (sel) => document.querySelector(sel);
    const stream = $("#stream");
    const input = $("#input");
    const sendBtn = $("#sendBtn");
    const chip = $("#sessionChip");
    const cfgBtn = $("#cfgBtn");
    const dlg = $("#cfgDlg");
    const baseUrlEl = $("#baseUrl");
    const pathEl = $("#path");
    const headersEl = $("#headers");
    const saveCfgBtn = $("#saveCfgBtn");
    const closeCfgBtn = $("#closeCfgBtn");
    const newSessBtn = $("#newSessBtn");

    function push(role, text) {
      const row = document.createElement("div");
      row.className = "row " + role;
      const b = document.createElement("div");
      b.className = "bubble";
      b.textContent = String(text ?? "");
      row.appendChild(b);
      stream.appendChild(row);
      stream.scrollTop = stream.scrollHeight;
      return row;
    }

    function setTyping(on) { stream.setAttribute("aria-busy", on ? "true" : "false"); }

    // ===== Storage =====
    const K = { base: "tot.baseUrl", path: "tot.path", headers: "tot.headers", sid: "tot.sid" };

    function uuid() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11)
        .replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16));
    }

    function getSession() {
      let id = localStorage.getItem(K.sid);
      if (!id) { id = uuid(); localStorage.setItem(K.sid, id); }
      return id;
    }

    function updateChip() {
      const sid = AGENT_PREFIX + getSession();
      chip.textContent = "Sesión: " + sid.slice(0, 8);
      chip.title = sid;
    }

    function safeParse(jsonText) {
      try { return jsonText ? JSON.parse(jsonText) : {}; } catch { return {}; }
    }

    function getConfig() {
      const base = localStorage.getItem(K.base) || "";
      const p = localStorage.getItem(K.path) || "";
      const hdrs = safeParse(localStorage.getItem(K.headers));
      if (!base && !p) return { base: "", path: DEFAULT_WEBHOOK, headers: hdrs };
      return { base, path: p, headers: hdrs };
    }

    function setConfig(o) {
      if ("baseUrl" in o) localStorage.setItem(K.base, o.baseUrl || "");
      if ("path" in o) localStorage.setItem(K.path, o.path || "");
      if ("headers" in o) localStorage.setItem(K.headers, JSON.stringify(o.headers || {}));
    }

    // ===== Llamada al agente =====
    async function callAgent(message) {
      const cfg = getConfig();
      let url = (cfg.base || "").trim();
      if (url && cfg.path) url = url.replace(/\/+$/, "") + "/" + String(cfg.path).replace(/^\/+/, "");
      if (!url) url = cfg.path || DEFAULT_WEBHOOK;
      if (!/^https?:\/\//i.test(url)) throw new Error("La URL del webhook debe empezar con http(s)://");

      const sessionId = AGENT_PREFIX + getSession();
      const payload = { chatInput: message, sessionId };

      const res = await fetch(url, {
        method: "POST",
        mode: "cors",
        credentials: "omit",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload),
        cache: "no-store"
      });
      const text = await res.text();
      if (!res.ok) throw new Error("HTTP " + res.status + ": " + text);
      try {
        const j = JSON.parse(text);
        return j.response ?? j.text ?? j.answer ?? j.message ?? text;
      } catch {
        return text;
      }
    }

    // ===== Eventos =====
    cfgBtn.addEventListener("click", () => {
      const cfg = getConfig();
      baseUrlEl.value = cfg.base;
      pathEl.value = cfg.path;
      headersEl.value = JSON.stringify(cfg.headers || {});
      dlg.showModal();
    });

    saveCfgBtn.addEventListener("click", () => {
      let headers = {};
      try { headers = headersEl.value ? JSON.parse(headersEl.value) : {}; } catch { headers = {}; }
      setConfig({ baseUrl: baseUrlEl.value, path: pathEl.value, headers });
      dlg.close();
    });

    closeCfgBtn.addEventListener("click", () => dlg.close());

    newSessBtn.addEventListener("click", () => {
      localStorage.removeItem(K.sid);
      updateChip();
    });

    sendBtn.addEventListener("click", async () => {
      const msg = input.value.trim();
      if (!msg) return;
      input.value = "";
      push("user", msg);
      setTyping(true);
      try {
        const ans = await callAgent(msg);
        push("bot", ans || "— (sin contenido)");
      } catch (err) {
        const msgErr = (err && err.message) ? err.message : String(err);
        push("bot", "⚠️ " + msgErr);
      } finally {
        setTyping(false);
      }
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // ===== Boot =====
    updateChip();

    // Auto-scroll (observer inline)
    const mo = new MutationObserver(() => { stream.scrollTop = stream.scrollHeight; });
    mo.observe(stream, { childList: true, subtree: false });
    window.addEventListener("resize", () => { stream.scrollTop = stream.scrollHeight; });
  })();
  </script>
</body>
</html>lay:flex; gap:8px}
  button, .btn{
    appearance:none; border:1px solid var(--border); background:var(--panel-2); color:var(--text);
    padding:10px 12px; border-radius:12px; cursor:pointer;
    transition:transform .08s ease, background .2s ease, border-color .2s ease, opacity .2s;
  }
  button:hover{border-color:#2a3444; background:#0f1722}
  button:active{transform:translateY(1px)}
  .btn-outline{background:transparent}
  .btn-accent{background:linear-gradient(180deg,#1d344e,#142234); border-color:#24415f}
  .btn-accent:hover{border-color:#315a81}
  .muted{color:var(--muted)}
  main{
    flex:1; display:flex; flex-direction:column; gap:0;
    padding:16px; scroll-behavior:smooth;
  }
  .stream{
    flex:1; overflow:auto; display:flex; flex-direction:column; gap:14px; padding-bottom:8px;
  }
  .row{display:flex; gap:10px; align-items:flex-end;}
  .row.user{justify-content:flex-end}
  .avatar{
    width:28px; height:28px; border-radius:50%;
    background:#0f1b2a; border:1px solid var(--border); flex:none;
  }
  .avatar.bot{background:#0d1a12}
  .bubble{
    max-width:min(680px, 85%); padding:12px 14px; border-radius:14px;
    border:1px solid var(--border); box-shadow: var(--shadow);
    background:var(--bubble-bot); color:var(--text); white-space:pre-wrap; word-wrap:break-word;
  }
  .row.user .bubble{background:var(--bubble-user)}
  .meta{font-size:12px; color:var(--muted); margin-top:6px}
  .inputbar{
    position:sticky; bottom:0; z-index:10; padding:12px 16px; background:linear-gradient(0deg, rgba(15,20,26,.92), rgba(15,20,26,.75));
    border-top:1px solid var(--border); backdrop-filter: blur(8px);
  }
  .composer{
    display:flex; align-items:flex-end; gap:10px; background:var(--panel); border:1px solid var(--border);
    border-radius:16px; padding:10px; box-shadow: var(--shadow);
  }
  textarea{
    flex:1; resize:none; min-height:44px; max-height:170px; border:0; outline:0; background:transparent; color:var(--text);
  }
  .send{display:flex; gap:8px}
  .chip{
    font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid var(--border);
    background:rgba(77,163,255,.1); color:#b6d8ff;
  }
  .toast{
    position:fixed; right:16px; bottom:16px; background:#1b0f12; color:#ffd7df; border:1px solid #4b1823;
    padding:10px 12px; border-radius:10px; box-shadow: var(--shadow); display:none;
  }
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; padding:.5px 6px; border:1px solid var(--border); border-radius:6px; color:var(--muted)}
  /* Modal */
  dialog{
    border:1px solid var(--border); border-radius:16px; background:var(--panel); color:var(--text);
    padding:0; box-shadow: var(--shadow); width:min(720px, 92vw);
  }
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .modal-head{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border)}
  .modal-body{padding:16px; display:grid; gap:12px}
  .field{display:grid; gap:6px}
  .field label{font-size:13px; color:var(--muted)}
  .field input{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    background:var(--panel-2); color:var(--text);
  }
  .modal-actions{display:flex; justify-content:flex-end; gap:8px; padding:14px 16px; border-top:1px solid var(--border)}
  .hint{font-size:12px; color:var(--muted)}
  @media (max-width:520px){
    header{padding:12px}
    .brand h1{font-size:15px}
    .composer{padding:8px}
    .actions .chip{display:none}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Chat con TOT</h1>
          <div class="muted" style="font-size:12px">RAG · n8n Webhook · GitHub Pages</div>
        </div>
      </div>
      <div class="actions">
        <span id="sessionChip" class="chip" title="Session ID para memoria">Sesión: —</span>
        <button id="newSessionBtn" class="btn btn-outline" title="Regenerar Session ID">↻ Sesión</button>
        <button id="configBtn" class="btn btn-accent" title="Configurar webhook">⚙︎ Configurar</button>
      </div>
    </header>

    <main>
      <div id="stream" class="stream" aria-live="polite" aria-busy="false"></div>
    </main>

    <div class="inputbar">
      <div class="composer">
        <textarea id="input" placeholder="Escribe tu mensaje… (Enter para enviar, Shift+Enter salto de línea)" rows="1"></textarea>
        <div class="send">
          <button id="sendBtn" class="btn btn-accent">Enviar ▷</button>
        </div>
      </div>
      <div class="hint" style="margin-top:8px">
        Consejo: presiona <span class="kbd">Enter</span> para enviar · <span class="kbd">Shift</span> + <span class="kbd">Enter</span> para saltar línea
      </div>
    </div>
  </div>

  <dialog id="configModal">
    <div class="modal-head">
      <strong>Configuración de endpoint</strong>
      <button id="closeConfig" class="btn btn-outline">✕</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label for="baseUrl">Base URL del Webhook (sin la parte /webhook/… si ya la incluyes completa)</label>
        <input id="baseUrl" placeholder="https://TU-DOMINIO-N8N/webhook" />
      </div>
      <div class="field">
        <label for="path">Path del Webhook (si tu Base URL ya incluye /webhook/ID, deja esto vacío)</label>
        <input id="path" placeholder="bf4dd093-bb02-472c-9454-7ab9af97bd1d" />
      </div>
      <div class="field">
        <label for="headers">Headers opcionales (JSON)</label>
        <input id="headers" placeholder='{"Authorization":"Bearer ..."}' />
      </div>
      <div class="hint">
        Este chat hace <code>POST</code> con <code>{ "chatInput": "...", "sessionId": "..." }</code> y muestra la respuesta del nodo <em>Respond to Webhook</em>.
      </div>
    </div>
    <div class="modal-actions">
      <button id="saveConfig" class="btn btn-accent">Guardar</button>
    </div>
  </dialog>

  <div id="toast" class="toast" role="status"></div>

<script>
(() => {
  // ------- State & Storage -------
  const $ = sel => document.querySelector(sel);
  const stream = $("#stream");
  const input = $("#input");
  const sendBtn = $("#sendBtn");
  const configBtn = $("#configBtn");
  const configModal = $("#configModal");
  const closeConfig = $("#closeConfig");
  const saveConfig = $("#saveConfig");
  const baseUrlEl = $("#baseUrl");
  const pathEl = $("#path");
  const headersEl = $("#headers");
  const sessionChip = $("#sessionChip");
  const newSessionBtn = $("#newSessionBtn");
  const toast = $("#toast");

  const STORAGE_KEYS = {
    baseUrl: "tot.baseUrl",
    path: "tot.path",
    headers: "tot.headers",
    sessionId: "tot.sessionId",
    history: "tot.history"
  };

  const DEFAULT_WEBHOOK = "https://metatron.aircraftcare.net/webhook/bf4dd093-bb02-472c-9454-7ab9af97bd1d";
  const AGENT_PREFIX = "tot:";

  function uuidv4(){
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16)
    );
  }

  function getConfig(){
    const baseUrlStored = localStorage.getItem(STORAGE_KEYS.baseUrl) ?? "";
    const pathStored    = localStorage.getItem(STORAGE_KEYS.path) ?? "";
    const headers       = safeParse(localStorage.getItem(STORAGE_KEYS.headers)) ?? {};
  
    // Si no hay nada guardado, usar el endpoint por defecto
    if (!baseUrlStored && !pathStored) {
      return { baseUrl: "", path: DEFAULT_WEBHOOK, headers };
    }
    return { baseUrl: baseUrlStored, path: pathStored, headers };
  }

  function setConfig({baseUrl, path, headers}){
    if (typeof baseUrl === "string") localStorage.setItem(STORAGE_KEYS.baseUrl, baseUrl.trim());
    if (typeof path === "string") localStorage.setItem(STORAGE_KEYS.path, path.trim());
    if (headers && typeof headers === "object") localStorage.setItem(STORAGE_KEYS.headers, JSON.stringify(headers));
    loadConfigIntoModal();
  }

  function getSession(){
    let id = localStorage.getItem(STORAGE_KEYS.sessionId);
    if(!id){ id = uuidv4(); localStorage.setItem(STORAGE_KEYS.sessionId, id); }
    return id;
  }
  function rotateSession(){
    const id = uuidv4();
    localStorage.setItem(STORAGE_KEYS.sessionId, id);
    updateSessionChip();
    pushSys("Se generó un nuevo Session ID.");
  }

  function updateSessionChip(){
    const id = getSession();
    sessionChip.textContent = "Sesión: " + id.slice(0, 8);
    sessionChip.title = id;
  }

  function safeParse(str){
    if(!str) return null;
    try{ return JSON.parse(str); } catch { return null; }
  }

  function saveHistory(msgs){
    localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(msgs));
  }
  function loadHistory(){
    return safeParse(localStorage.getItem(STORAGE_KEYS.history)) ?? [];
  }

  // ------- UI Helpers -------
  function el(tag, attrs={}, children=[]){
    const node = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){ 
      if(k==="class") node.className = v;
      else if(k.startsWith("on") && typeof v === "function") node.addEventListener(k.substring(2), v);
      else node.setAttribute(k,v);
    }
    children.forEach(ch => {
      if(typeof ch === "string") node.appendChild(document.createTextNode(ch));
      else if(ch) node.appendChild(ch);
    });
    return node;
  }

  function nowTime(){ 
    // Simple HH:MM
    const d = new Date();
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  function pushMsg(role, text, meta = ""){
    const row = el("div", {class: "row " + (role==="user" ? "user" : "bot")});
    const avatar = el("div", {class: "avatar " + (role==="bot" ? "bot": "user")});
    const bubble = el("div", {class:"bubble"}, [text]);
    const aside = el("div", {class:"meta"}, [meta || nowTime()]);
    const wrap = el("div");
    wrap.appendChild(bubble); wrap.appendChild(aside);
    if(role==="user"){ row.appendChild(wrap); row.appendChild(avatar); }
    else { row.appendChild(avatar); row.appendChild(wrap); }
    stream.appendChild(row);
    stream.scrollTop = stream.scrollHeight;
    persist();
  }

  function pushTyping(){
    const id = "typing-"+Date.now();
    const row = el("div", {class:"row bot", id});
    const avatar = el("div", {class:"avatar bot"});
    const bubble = el("div", {class:"bubble"}, ["…"]);
    bubble.style.opacity = .7;
    row.appendChild(avatar); row.appendChild(el("div", {}, [bubble, el("div",{class:"meta"},["Escribiendo…"])]));
    stream.appendChild(row);
    stream.scrollTop = stream.scrollHeight;
    return id;
  }

  function replaceTyping(id, text){
    const node = document.getElementById(id);
    if(!node) return;
    node.remove();
    pushMsg("bot", text);
  }

  function pushSys(text){ pushMsg("bot", "ℹ️ " + text); }

  function toastShow(msg, ms=3200){
    toast.textContent = msg;
    toast.style.display = "block";
    setTimeout(()=> toast.style.display="none", ms);
  }

  // ------- Modal -------
  function loadConfigIntoModal(){
    const {baseUrl, path, headers} = getConfig();
    baseUrlEl.value = baseUrl;
    pathEl.value = path;
    headersEl.value = headers ? JSON.stringify(headers) : "";
  }
  function openConfig(){ loadConfigIntoModal(); configModal.showModal(); }
  function closeConfigModal(){ configModal.close(); }

  // ------- Persistence of messages -------
  function persist(){
    const msgs = [...stream.querySelectorAll(".row")].map(row=>{
      const role = row.classList.contains("user") ? "user":"bot";
      const text = row.querySelector(".bubble")?.textContent ?? "";
      return {role, text};
    });
    saveHistory(msgs);
  }

  function restore(){
    const msgs = loadHistory();
    if(!msgs.length){
      pushSys("Configura tu endpoint con ⚙︎ y envía tu primer mensaje.");
      pushSys("Este cliente manda JSON { chatInput, sessionId } y muestra la respuesta de n8n.");
      return;
    }
    msgs.forEach(m=> pushMsg(m.role, m.text));
  }

  // ------- Networking to n8n -------
  async function sendToTOT(message){
      const { baseUrl, path, headers } = getConfig();
      let url = (baseUrl || "").trim();
      if(url && path){ url = url.replace(/\/+$/,"") + "/" + String(path).replace(/^\/+/,""); }
      if(!url) url = path || DEFAULT_WEBHOOK;
      if(!/^https?:\/\//i.test(url)) throw new Error("La URL del webhook debe empezar con http(s)://");

      const sessionId = AGENT_PREFIX + getSession();
      const payload = { chatInput: message, sessionId };

      try {
        const resp = await fetch(url, {
          method: "POST",
          mode: "cors",
          credentials: "omit",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(payload),
          cache: "no-store",
        });
        const text = await resp.text();
        if(!resp.ok){ throw new Error(`HTTP ${resp.status}: ${text}`); }
        let data; try { data = JSON.parse(text); } catch { data = null; }
        let answer = "";
        if (typeof data === "string") answer = data;
        else if (data) answer = data.text ?? data.answer ?? data.message ?? data.output ?? data.result ?? text;
        else answer = text;
        return String(answer).trim();
      } catch (err){
        if (err instanceof TypeError) {
          throw new Error("El navegador bloqueó la llamada por CORS (falta Access-Control-Allow-Origin en la respuesta del webhook).");
        }
        throw err;
      }
    

  // ------- Events -------
  sendBtn.addEventListener("click", onSend);
  input.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault(); onSend();
    }
  });
  configBtn.addEventListener("click", openConfig);
  closeConfig.addEventListener("click", closeConfigModal);
  saveConfig.addEventListener("click", ()=>{
    let headers = safeParse(headersEl.value);
    if(headersEl.value && !headers){ toastShow("Headers no es JSON válido"); return; }
    setConfig({ baseUrl: baseUrlEl.value, path: pathEl.value, headers });
    closeConfigModal(); toastShow("Configuración guardada");
  });
  newSessionBtn.addEventListener("click", rotateSession);

  async function onSend(){
    const text = input.value.trim();
    if(!text) return;
    input.value = "";
    pushMsg("user", text);
    const typingId = pushTyping();
    try{
      const answer = await sendToTOT(text);
      replaceTyping(typingId, answer || "— (sin contenido)");
    }catch(err){
      console.error(err);
      replaceTyping(typingId, "⚠️ Error al consultar el agente.\n" + (err?.message ?? String(err)));
      toastShow("Error al consultar el agente");
    }
  }

  // ------- Boot -------
  updateSessionChip();
  restore();
})();
</script>
  <!-- Auto-scroll global -->
<script>(function(){const stream=document.getElementById("stream");if(!stream)return;const mo=new MutationObserver(()=>{stream.scrollTop=stream.scrollHeight;});mo.observe(stream,{childList:true});window.addEventListener("resize",()=>{stream.scrollTop=stream.scrollHeight;});})();</script>
</body>
</html>
